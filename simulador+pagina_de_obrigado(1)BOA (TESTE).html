<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Ademicon</title>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Usando Inter como sugerido */
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* NOVO ESTILO PARA O BACKGROUND DINÂMICO */
        .background-simulador {
            position: fixed; /* Fixa a imagem no viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover; /* Garante que a imagem cubra toda a área */
            background-position: center; /* Centraliza a imagem */
            filter: brightness(0.7) contrast(1.1) saturate(0.9); /* Ajustes para "apagado" e sutil */
            opacity: 0.7; /* Controla a transparência geral da imagem */
            z-index: -1; /* Garante que fique atrás do conteúdo do simulador-box */
            transition: background-image 0.8s ease-in-out, filter 0.8s ease-in-out, opacity 0.8s ease-in-out; /* Transição suave */
            /* O background-image inicial será definido via JavaScript */
            /* O gradiente é adicionado via JS junto com a URL da imagem para controle flexível */
        }

        .simulador-box {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            border-radius: 12px; /* Mais arredondado */
            padding: 25px;
            background: #fff;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15); /* Sombra mais suave */
            box-sizing: border-box; /* Garante padding dentro da largura */
            position: relative; /* Necessário para que o z-index funcione corretamente em relação ao background */
            z-index: 1; /* Para que fique acima do background */
        }

        .simulador-btn {
            cursor: pointer;
            padding: 12px 20px;
            border: 1px solid #ccc;
            border-radius: 8px; /* Mais arredondado */
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease; /* Transição para todas as propriedades */
            flex: 1; /* Para botões em grupos */
            background-color: #f0f0f0; /* Cor padrão para não ativos */
            color: #555;
        }

        .simulador-btn:hover {
            background-color: #e0e0e0;
        }

        .simulador-btn-active {
            background-color: #b3342b; /* Vermelho Ademicon */
            color: #fff;
            border-color: #b3342b;
            box-shadow: 0 4px 8px rgba(179, 52, 43, 0.3); /* Sombra para ativo */
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            margin: 8px 5px 0;
            font-size: 13px;
            color: #666;
        }

        .slider {
            width: 100%;
            -webkit-appearance: none; /* Remove default styling */
            appearance: none;
            height: 8px;
            background: #ddd;
            outline: none;
            border-radius: 5px;
            transition: background 0.2s ease-in-out;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #b3342b;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s ease-in-out;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #b3342b;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s ease-in-out;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border-radius: 8px; /* Mais arredondado */
            border: 1px solid #ccc;
            font-size: 16px;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .form-control:focus {
            border-color: #b3342b;
            box-shadow: 0 0 0 3px rgba(179, 52, 43, 0.2);
            outline: none;
        }

        .cep-buscar {
            margin-top: 8px;
            background-color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .cep-buscar:hover {
            background-color: #d0d0d0;
        }

        .informaroutrovalor {
            display: none;
            margin-top: 20px;
        }

        .informaroutrovalor small {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
        }

        .simulador-btn-dark {
            padding: 15px;
            font-size: 18px;
            color: white;
            background: linear-gradient(45deg, #b3342b, #ff6f61); /* Gradiente mais vibrante */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(179, 52, 43, 0.4);
        }

        .simulador-btn-dark:hover {
            background: linear-gradient(45deg, #ff6f61, #b3342b);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 10px; /* Distância entre os botões */
            margin-top: 20px;
        }

        .simulador-btn-voltar {
            background: #6c757d; /* Cinza para o botão voltar */
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .simulador-btn-voltar:hover {
            background-color: #5a6268;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        /* Estilos para os modais (CEP, Confirmação, Feedback) */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6); /* Fundo semi-transparente */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0px 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            text-align: center;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            font-size: 30px;
            font-weight: bold;
            color: #aaa;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: #666;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .modal-buttons .confirm-yes {
            background-color: #b3342b;
            color: white;
        }
        .modal-buttons .confirm-yes:hover {
            background-color: #ff6f61;
        }

        .modal-buttons .confirm-no, .modal-buttons .feedback-ok {
            background-color: #e0e0e0;
            color: #333;
        }
        .modal-buttons .confirm-no:hover, .modal-buttons .feedback-ok:hover {
            background-color: #d0d0d0;
        }

        /* Estilos para resultados da busca de CEP no modal */
        #resultadoBuscaCEP {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            border-radius: 8px;
            max-height: 200px; /* Limita a altura para scroll */
            overflow-y: auto;
            text-align: left;
        }
        #resultadoBuscaCEP p {
            margin: 8px 0;
            font-size: 14px;
            color: #444;
        }
        #resultadoBuscaCEP strong {
            color: #333;
        }
        #resultadoBuscaCEP button {
            background-color: #007bff;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 5px;
            transition: background-color 0.2s ease;
        }
        #resultadoBuscaCEP button:hover {
            background-color: #0056b3;
        }
        #resultadoBuscaCEP hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <div class="background-simulador" id="background-simulador"></div>

<div class="simulador-box" id="simulador-inicial">
    <p class="cor-site subt" style="font-size: 1.5rem; font-weight: bold; text-align: center; color: #b3342b; margin-bottom: 20px;">A hora de realizar<br>é agora.</p>

    <p style="margin-bottom: 15px; color: #333;">Selecione sua próxima conquista:</p>
    <div class="btn-group" style="margin-bottom: 25px;">
        <div onclick="setModalidade('imoveis')" class="simulador-btn simulador-btn-active" id="btn-imoveis">Imóveis</div>
        <div onclick="setModalidade('veiculos')" class="simulador-btn" id="btn-veiculos">Veículos</div>
        <div onclick="setModalidade('servicos')" class="simulador-btn" id="btn-servicos">Serviços</div>
    </div>

    <p style="margin-bottom: 15px; color: #333;">Simule o plano por:</p>
    <div class="btn-group" style="margin-bottom: 25px;">
        <div onclick="setPlano('parcela')" class="simulador-btn simulador-btn-active" id="btn-parcela">Parcela</div>
        <div onclick="setPlano('credito')" class="simulador-btn" id="btn-credito">Crédito</div>
    </div>

    <div id="simulador-range">
        <h2 style="text-align: center; font-size: 2.2rem; color: #b3342b; margin-bottom: 15px;">
            <small style="font-size: 0.7em; vertical-align: middle;">R$</small> <span id="valorExibido">0,00</span>
        </h2>
        <div class="form-group">
            <div class="range-field">
                <input type="range" min="400" max="4000" value="2200" class="slider" id="rangeInput" oninput="updateValor(this.value)">
                <div class="range-labels">
                    <span id="label-min">R$ 400,00</span>
                    <span id="label-max">R$ 4.000,00</span>
                </div>
            </div>
        </div>

        <div class="form-group informaroutrovalor">
            <small>Informar outro valor</small>
            <input type="text" class="money2 form-control" id="ipt-valor-outros" placeholder="R$ 0,00" oninput="formatarCampo(this)">
        </div>
    </div>

    <div class="btn-group">
        <button type="button" onclick="abrirFormularioUsuario()" class="simulador-btn-dark">Simular agora</button>
    </div>
</div>

<div id="formulario-usuario" class="simulador-box" style="display: none;">
    <p class="cor-site subt" style="font-size: 1.5rem; font-weight: bold; text-align: center; color: #b3342b; margin-bottom: 20px;">Realize seus planos<br>com a Ademicon</p>
    <p style="margin-bottom: 20px; color: #333;">Preencha os campos abaixo para ver os resultados:</p>

    <form id="simuladorForm">
        <div class="form-group">
            <label for="nome" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Nome:</label>
            <input type="text" id="nome" name="nome" class="form-control" placeholder="Seu nome" required>
        </div>

        <div class="form-group">
            <label for="telefone" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Telefone:</label>
            <input type="tel" id="telefone" name="telefone" class="form-control" placeholder="+55 (XX) 9XXXX-XXXX" required onfocus="ensurePhonePrefix()">
        </div>

        <div class="form-group">
            <label for="email" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">E-mail:</label>
            <input type="email" id="email" name="email" class="form-control" placeholder="seu@email.com" required>
        </div>

        <div class="form-group">
            <label for="cep" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">CEP:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="cep" name="cep" class="form-control" placeholder="00000-000" required style="flex-grow: 1;">
                <button type="button" onclick="abrirPopupCEP()" class="cep-buscar">Encontre seu CEP</button>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label style="display: flex; align-items: center; margin-bottom: 10px; color: #555;">
                <input type="checkbox" id="termos" name="aceitou termos" required style="margin-right: 8px;"> Aceito os Termos de Privacidade.
            </label>
            <label style="display: flex; align-items: center; color: #555;">
                <input type="checkbox" id="notificacoes" name="aceitou notificacoes" style="margin-right: 8px;"> Sim, eu concordo em receber notificações.
            </label>
        </div>

        <div class="btn-group">
            <button type="button" onclick="voltarSimulacao()" class="simulador-btn simulador-btn-voltar">Voltar</button>
            <button type="submit" class="simulador-btn-dark" id="submitButton">Gerar Resultado</button>
        </div>
    </form>
</div>

<div id="popupCEP" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn" onclick="fecharPopupCEP()">&times;</span>
        <h2 style="font-size: 1.8rem; font-weight: bold; color: #b3342b; margin-bottom: 25px;">Buscar CEP por Endereço</h2>
        <form id="popupBuscaCEP">
            <div class="form-group">
                <label for="uf" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Estado (UF):</label>
                <select id="uf" name="uf" class="form-control" required>
                    <option value="">Selecione o Estado</option>
                    <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amapá</option><option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Ceará</option><option value="DF">Distrito Federal</option><option value="ES">Espírito Santo</option><option value="GO">Goiás</option><option value="MA">Maranhão</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option><option value="MG">Minas Gerais</option><option value="PA">Pará</option><option value="PB">Paraíba</option><option value="PR">Paraná</option><option value="PE">Pernambuco</option><option value="PI">Piauí</option><option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option><option value="RO">Rondônia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option><option value="SP">São Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
                </select>
            </div>
            <div class="form-group">
                <label for="localidade" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Cidade:</label>
                <input type="text" id="localidade" name="localidade" class="form-control" placeholder="Ex: São Paulo" required>
            </div>
            <div class="form-group">
                <label for="logradouro" style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Rua/Avenida:</label>
                <input type="text" id="logradouro" name="logradouro" class="form-control" placeholder="Ex: Av. Paulista" required>
            </div>
            <button type="submit" class="simulador-btn-dark" style="width: auto; padding: 10px 20px;">Buscar CEP</button>
            <div id="resultadoBuscaCEP"></div>
        </form>
    </div>
</div>

<div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 20px;">Confirmação</h3>
        <p style="color: #555; margin-bottom: 25px;">Seus dados estão todos certos, confira antes do envio.</p>
        <div class="modal-buttons">
            <button class="confirm-no" onclick="handleConfirmation(false)">Cancelar</button>
            <button class="confirm-yes" onclick="handleConfirmation(true)">Confirmar</button>
        </div>
    </div>
</div>

<div id="feedbackModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 20px;">Aviso</h3>
        <p id="feedbackMessage" style="color: #555; margin-bottom: 25px;"></p>
        <div class="modal-buttons">
            <button class="feedback-ok" onclick="hideFeedbackModal()">Ok</button>
        </div>
    </div>
</div>

<script>
    let modalidadeAtual = 'imoveis';
    let planoAtual = 'parcela';
    let resolveConfirmationPromise; // Para controlar a promessa do modal de confirmação

    // IDs das imagens geradas (AGORA USANDO OS CAMINHOS LOCAIS)
    const imagensDeFundo = {
        imoveis: 'imagens/imoveis.jpg', // Caminho para a sua imagem de Imóveis (SALVEI COMO .JPG NA PASTA IMAGENS)
        veiculos: 'imagens/automovel.jpg', // Caminho para a sua imagem de Automóvel (SALVEI COMO .JPG NA PASTA IMAGENS)
        servicos: 'imagens/servicos.jpg'  // Caminho para a sua imagem de Serviços (SALVEI COMO .JPG NA PASTA IMAGENS)
    };

    const backgroundSimulador = document.getElementById('background-simulador'); // Adicione esta linha

    // Função para atualizar a imagem de fundo com gradiente
    function atualizarImagemDeFundo(modalidade) {
        if (backgroundSimulador && imagensDeFundo[modalidade]) {
            // Aplica o gradiente e a imagem de fundo
            backgroundSimulador.style.backgroundImage = `linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.6) 100%), url('${imagensDeFundo[modalidade]}')`;
        }
    }

    const ranges = {
        imoveis: {
            parcela: { min: 400, max: 4000, step: 1 },
            credito: { min: 100000, max: 1000000, step: 5000 }
        },
        veiculos: {
            parcela: { min: 278.40, max: 2815.56, step: 0.01 },
            credito: { min: 40000, max: 422160, step: 5000 }
        },
        servicos: {
            parcela: { min: 372, max: 744, step: 1 },
            credito: { min: 20000, max: 40000, step: 5000 }
        }
    };

    function setModalidade(mod) {
        modalidadeAtual = mod;
        document.querySelectorAll('#simulador-inicial .simulador-btn').forEach(btn => btn.classList.remove('simulador-btn-active'));
        document.getElementById('btn-' + mod).classList.add('simulador-btn-active');
        atualizarRange();
        atualizarImagemDeFundo(mod); // <<< LINHA IMPORTANTE: Atualiza a imagem de fundo
    }

    function setPlano(plano) {
        planoAtual = plano;
        document.getElementById('btn-parcela').classList.remove('simulador-btn-active');
        document.getElementById('btn-credito').classList.remove('simulador-btn-active');
        document.getElementById('btn-' + plano).classList.add('simulador-btn-active');
        atualizarRange();
    }

    function atualizarRange() {
        const config = ranges[modalidadeAtual][planoAtual];
        const rangeInput = document.getElementById('rangeInput');
        rangeInput.min = config.min;
        rangeInput.max = config.max;
        rangeInput.step = config.step;
        rangeInput.value = config.min; // Redefine o valor para o mínimo da nova faixa
        document.getElementById('valorExibido').innerText = formatarValor(rangeInput.value);
        document.getElementById('label-min').innerText = 'R$ ' + formatarValor(config.min);
        document.getElementById('label-max').innerText = 'R$ ' + formatarValor(config.max);

        // Lógica para mostrar/esconder o campo "Informar outro valor"
        if (parseFloat(rangeInput.value) >= config.max) {
            document.querySelector('.informaroutrovalor').style.display = 'block';
        } else {
            document.querySelector('.informaroutrovalor').style.display = 'none';
            document.getElementById('ipt-valor-outros').value = ''; // Limpa o campo
        }
    }

    function updateValor(valor) {
        document.getElementById('valorExibido').innerText = formatarValor(valor);
        const config = ranges[modalidadeAtual][planoAtual];
        if (parseFloat(valor) >= config.max) {
            document.querySelector('.informaroutrovalor').style.display = 'block';
        } else {
            document.querySelector('.informaroutrovalor').style.display = 'none';
            document.getElementById('ipt-valor-outros').value = ''; // Limpa o campo
        }
    }

    function formatarValor(valor) {
        return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatarCampo(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor.length === 0) {
            input.value = '';
            return;
        }
        valor = valor.padStart(3, '0');
        valor = (parseInt(valor) / 100).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        input.value = valor;
    }

    // Função para formatar o telefone (apenas números de celular brasileiros)
    function formatarTelefone(input) {
        let rawValue = input.value;
        // Remove o prefixo "+55 " e depois todos os não-dígitos
        let digitsOnly = rawValue.replace(/^\+55\s?/, '').replace(/\D/g, '');

        // Limita a 11 dígitos para números de celular brasileiros (2 para DDD, 9 para o número)
        if (digitsOnly.length > 11) {
            digitsOnly = digitsOnly.substring(0, 11);
        }

        let formatted = '';

        if (digitsOnly.length > 0) {
            let ddd = digitsOnly.substring(0, Math.min(2, digitsOnly.length));
            let firstPart = digitsOnly.substring(2, Math.min(7, digitsOnly.length)); // 9XXXX
            let secondPart = digitsOnly.substring(7, Math.min(11, digitsOnly.length)); // XXXX

            if (ddd.length > 0) {
                formatted += `(${ddd}`;
            }
            if (firstPart.length > 0) {
                formatted += `) ${firstPart}`;
            }
            if (secondPart.length > 0) {
                formatted += `-${secondPart}`;
            }
            formatted = '+55 ' + formatted;
        } else {
            formatted = '+55 '; // Mantém o prefixo se nenhum dígito for inserido
        }
        input.value = formatted;
    }

    // Função para garantir que o prefixo +55 esteja presente ao focar no campo
    function ensurePhonePrefix() {
        const telefoneInput = document.getElementById('telefone');
        if (telefoneInput.value.trim() === '' || telefoneInput.value.trim() === '+55') {
            telefoneInput.value = '+55 ';
        }
    }

    // Função para preencher o telefone com +55 e DDD baseado na localização do IP
    async function prefillPhoneBasedOnLocation() {
        try {
            const response = await fetch('https://ip-api.com/json');
            const data = await response.json();

            if (data.status === 'success' && data.countryCode === 'BR') {
                const telefoneInput = document.getElementById('telefone');
                if (telefoneInput.value.trim() === '' || telefoneInput.value.trim() === '+55') {
                    // A API ip-api.com não fornece o DDD diretamente, apenas estado e cidade.
                    // Para evitar erros de formatação, vamos apenas garantir o '+55 '
                    // e deixar a máscara de input guiar o utilizador para o DDD e o número.
                    telefoneInput.value = '+55 ';
                }
            }
        } catch (error) {
            console.error('Erro ao obter dados de localização:', error);
            // Se a API falhar, ainda garantimos o prefixo +55
            const telefoneInput = document.getElementById('telefone');
            if (telefoneInput.value.trim() === '') {
                telefoneInput.value = '+55 ';
            }
        }
    }

    function abrirFormularioUsuario() {
        document.getElementById('simulador-inicial').style.display = 'none';
        document.getElementById('formulario-usuario').style.display = 'block';
    }

    function voltarSimulacao() {
        document.getElementById('formulario-usuario').style.display = 'none';
        document.getElementById('simulador-inicial').style.display = 'block';
        document.getElementById('simuladorForm').reset(); // Limpa o formulário de dados do usuário
        // Re-aplica a formatação do telefone ao voltar, caso o utilizador tenha apagado tudo
        prefillPhoneBasedOnLocation();
    }

    // **** URL DO SEU GOOGLE APPS SCRIPT ****
    // URL atualizada para o seu Google Apps Script
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwX7rNdzR-BQRjMODY5xXsmM0kQUTE8nZXRl_xo8a8HOLI9l1uzd4_ZlWCIJq-EqU4APw/exec'; // Corrigido para a URL fornecida pelo utilizador

    // Funções para o Modal de Confirmação
    function showConfirmationModal() {
        document.getElementById('confirmationModal').style.display = 'flex';
        return new Promise(resolve => {
            resolveConfirmationPromise = resolve;
        });
    }

    function handleConfirmation(confirmed) {
        document.getElementById('confirmationModal').style.display = 'none';
        if (resolveConfirmationPromise) {
            resolveConfirmationPromise(confirmed);
        }
    }

   // Funções para o Modal de Feedback
let resolveFeedbackPromise; // Adicione esta linha para controlar a promessa do feedback

function showFeedbackModal(message) {
    document.getElementById('feedbackMessage').innerText = message;
    document.getElementById('feedbackModal').style.display = 'flex';
    // Retorna uma Promessa que será resolvida quando o usuário clicar em "Ok"
    return new Promise(resolve => {
        resolveFeedbackPromise = resolve;
    });
}

function hideFeedbackModal() {
    document.getElementById('feedbackModal').style.display = 'none';
    if (resolveFeedbackPromise) {
        resolveFeedbackPromise(true); // Resolve a promessa quando o modal é fechado
    }
}

    document.addEventListener('DOMContentLoaded', function() {
        atualizarRange(); // Inicializa o range ao carregar a página
        prefillPhoneBasedOnLocation(); // Tenta pré-preencher o telefone ao carregar

        // Adiciona o event listener para o campo de telefone
        document.getElementById('telefone').addEventListener('input', function() {
            formatarTelefone(this);
        });

        // <<< LINHA IMPORTANTE: Define a imagem inicial ao carregar a página
        atualizarImagemDeFundo(modalidadeAtual); // Define a imagem inicial (Imóveis, por padrão)

        const simuladorForm = document.getElementById('simuladorForm');
        if (simuladorForm) {
            simuladorForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                const submitButton = document.getElementById('submitButton');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';

                // Mostra o modal de confirmação e aguarda a resposta
                const confirmed = await showConfirmationModal();
                if (!confirmed) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Gerar Resultado';
                    return;
                }

                // Prepara os dados do formulário para o Google Apps Script
                const formData = new FormData(this);
                const dataForGAS = {};
                for (let [key, value] of formData.entries()) {
                    dataForGAS[key] = value;
                }

                // Adiciona os valores da simulação inicial
                dataForGAS['modalidade'] = modalidadeAtual;
                dataForGAS['plano'] = planoAtual;
                
                let valorSimuladoFinal;
                const rangeInput = document.getElementById('rangeInput');
                const iptValorOutros = document.getElementById('ipt-valor-outros');

                // Verifica se o campo "Informar outro valor" está visível e preenchido
                if (document.querySelector('.informaroutrovalor').style.display === 'block' && iptValorOutros.value.trim() !== '') {
                    // Remove pontos e troca vírgula por ponto para parsear como número
                    valorSimuladoFinal = iptValorOutros.value.replace(/\./g, '').replace(',', '.');
                } else {
                    valorSimuladoFinal = rangeInput.value;
                }
                // Formata o valor final para o formato de exibição na planilha (ex: "1.000,00")
                dataForGAS['valor simulado'] = parseFloat(valorSimuladoFinal).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // Garante que o telefone é enviado sem a formatação extra, apenas com +55 e dígitos
                let rawTelefoneValue = document.getElementById('telefone').value;
                // Remove o prefixo "+55 " e depois todos os não-dígitos
                let cleanedDigits = rawTelefoneValue.replace(/^\+55\s?/, '').replace(/\D/g, '');
                // Prepend "+55" to the cleaned digits for the sheet
                dataForGAS['telefone'] = '+55' + cleanedDigits;

                // CORREÇÃO AQUI para os checkboxes: Garante que "Sim" ou "Não" é enviado
                const termosCheckbox = document.getElementById('termos');
                const notificacoesCheckbox = document.getElementById('notificacoes');

                // Alterado para corresponder aos nomes das colunas na planilha com espaços
                dataForGAS['aceitou termos'] = termosCheckbox.checked ? 'Sim' : 'Não'; 
                dataForGAS['aceitou notificacoes'] = notificacoesCheckbox.checked ? 'Sim' : 'Não'; 

                console.log('Dados a serem enviados para o Apps Script:', dataForGAS); // Log para depuração

                let gasSuccess = false;
                let errorMessage = '';

                // Requisição para o Google Apps Script
                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: new URLSearchParams(dataForGAS).toString(), // Converte para URL-encoded
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro ao enviar para Google Apps Script: ${response.status} - ${errorText}`);
                    }
                    const result = await response.text();
                    console.log('Resposta do Apps Script:', result);
                    gasSuccess = true;

                } catch (error) {
                    console.error('Erro ao enviar para Apps Script:', error);
                    errorMessage += 'Erro ao enviar para a Planilha. ';
                    gasSuccess = false;
                }
                
               // Feedback final ao utilizador
                if (gasSuccess) {
                    // Mostra o modal de feedback e aguarda o usuário clicar em "Ok"
                    await showFeedbackModal('✅Simulação enviada com sucesso! Breve entraremos em contacto.');

                    // Após o usuário clicar em "Ok", redireciona para a página de obrigado
                    window.location.href = 'obrigado.html'; // <<< Redireciona AQUI
                } else {
                    // Em caso de erro, mostra a mensagem de erro e reabilita o botão para nova tentativa
                    showFeedbackModal('Ocorreu um erro ao enviar sua simulação para a planilha. ' + errorMessage + 'Por favor, tente novamente mais tarde.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Gerar Resultado';
                    simuladorForm.reset(); // Limpa o formulário
                    voltarSimulacao();    // Volta para a tela inicial
                }
            });
        } else {
            console.error('Formulário com ID "simuladorForm" não encontrado.');
        }
    });

    // Funções para o popup de busca de CEP
    function abrirPopupCEP() {
        document.getElementById('popupCEP').style.display = 'flex';
        document.getElementById('resultadoBuscaCEP').innerHTML = '';
        document.getElementById('uf').value = '';
        document.getElementById('localidade').value = '';
        document.getElementById('logradouro').value = '';
    }

    function fecharPopupCEP() {
        document.getElementById('popupCEP').style.display = 'none';
    }

    document.getElementById('popupBuscaCEP').addEventListener('submit', async function(event) {
        event.preventDefault();

        const uf = document.getElementById('uf').value;
        const localidade = document.getElementById('localidade').value;
        const logradouro = document.getElementById('logradouro').value;
        const resultadoDiv = document.getElementById('resultadoBuscaCEP');

        resultadoDiv.innerHTML = '<p style="text-align: center; color: #666;">Buscando CEPs...</p>';

        if (!uf || !localidade || !logradouro) {
            resultadoDiv.innerHTML = '<p style="color: red; text-align: center;">Por favor, preencha Estado, Cidade e Rua.</p>';
            return;
        }

        const url = `https://viacep.com.br/ws/${uf}/${localidade}/${logradouro}/json/`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.erro) {
                resultadoDiv.innerHTML = '<p style="color: red; text-align: center;">CEP não encontrado para o endereço informado.</p>';
                return;
            }

            if (data.length === 0) {
                resultadoDiv.innerHTML = '<p style="text-align: center;">Nenhum CEP encontrado para o endereço informado.</p>';
                return;
            }

            let htmlResult = '<h3 style="font-size: 1.2em; margin-bottom: 10px; color: #333;">CEPs encontrados:</h3>';
            data.forEach(endereco => {
                if (endereco.cep) {
                    htmlResult += `
                        <p>
                            <strong>CEP:</strong> ${endereco.cep}<br>
                            <strong>Endereço:</strong> ${endereco.logradouro || ''}, ${endereco.bairro || ''}<br>
                            <strong>Cidade/UF:</strong> ${endereco.localidade || ''}/${endereco.uf || ''}
                            <button type="button" onclick="selecionarCEP('${endereco.cep}')">Selecionar</button>
                        </p>
                        <hr>
                    `;
                }
            });
            resultadoDiv.innerHTML = htmlResult;

        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            resultadoDiv.innerHTML = '<p style="color: red; text-align: center;">Erro ao buscar CEP. Tente novamente mais tarde.</p>';
        }
    });

    function selecionarCEP(cep) {
        document.getElementById('cep').value = cep.replace(/\D/g, '').replace(/^(\d{5})(\d{3})$/, '$1-$2');
        fecharPopupCEP();
    }

</script>

</body>
</html>